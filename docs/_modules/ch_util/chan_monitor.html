

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ch_util.chan_monitor &mdash; ch_util 25.3.1.post7+git.a3fec444 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/katex-math.css?v=05624691" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=1d928e64"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/katex.min.js?v=5cc8ed51"></script>
      <script src="../../_static/auto-render.min.js?v=af98beb9"></script>
      <script src="../../_static/katex_autorenderer.js?v=bebc588a"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ch_util
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ch_util</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ch_util.chan_monitor</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ch_util.chan_monitor</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Channel quality monitor routines&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">caput.time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ctime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ch_ephem.observers</span><span class="w"> </span><span class="kn">import</span> <span class="n">chime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ch_ephem.sources</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">chimedb</span><span class="w"> </span><span class="kn">import</span> <span class="n">data_index</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ch_util</span><span class="w"> </span><span class="kn">import</span> <span class="n">finder</span>

<span class="c1"># Corrections to transit times due to 2deg rotation of cylinders:</span>
<span class="n">TTCORR</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;CygA&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">94.4</span><span class="p">,</span> <span class="s2">&quot;CasA&quot;</span><span class="p">:</span> <span class="mf">152.3</span><span class="p">,</span> <span class="s2">&quot;TauA&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">236.9</span><span class="p">,</span> <span class="s2">&quot;VirA&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">294.5</span><span class="p">}</span>

<span class="n">CR</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>  <span class="c1"># Cylinder rotation in radians</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">CR</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">CR</span><span class="p">)],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">CR</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">CR</span><span class="p">)]]</span>
<span class="p">)</span>  <span class="c1"># Cylinder rotation matrix</span>
<span class="n">C</span> <span class="o">=</span> <span class="mf">2.9979e8</span>
<span class="n">PHI</span> <span class="o">=</span> <span class="n">chime</span><span class="o">.</span><span class="n">latitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>  <span class="c1"># DRAO Latitue</span>
<span class="n">SD</span> <span class="o">=</span> <span class="mf">24.0</span> <span class="o">*</span> <span class="mf">3600.0</span> <span class="o">*</span> <span class="n">ctime</span><span class="o">.</span><span class="n">SIDEREAL_S</span>  <span class="c1"># Sidereal day</span>

<span class="n">_DEFAULT_NODE_SPOOF</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scinet_online&quot;</span><span class="p">:</span> <span class="s2">&quot;/scratch/k/krs/jrs65/chime/archive/online/&quot;</span><span class="p">}</span>
<span class="c1"># _DEFAULT_NODE_SPOOF = {&#39;gong&#39;: &#39;/mnt/gong/archive&#39;} # For tests on Marimba</span>


<div class="viewcode-block" id="FeedLocator">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.FeedLocator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FeedLocator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class contains functions that do all the computations to</span>
<span class="sd">    determine feed positions from data. It also determines the quality</span>
<span class="sd">    of data and returns a list of good inputs and frequencies.</span>

<span class="sd">    Uppon initialization, it receives visibility data around one or two</span>
<span class="sd">    bright sources transits as well as corresponding meta-data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vis1, [vis2] : Visibility data around bright source transit</span>
<span class="sd">    tm1, [tm2] : Timestamp corresponding to vis1 [vis2]</span>
<span class="sd">    src1, [src2] : Ephemeris astronomical object corresponding to the</span>
<span class="sd">                   transit in vis1 [vis2]</span>
<span class="sd">    freqs : frequency axis of vis1 [and vis2]</span>
<span class="sd">    prods : Product axis of vis1 [and vis2]</span>
<span class="sd">    inputs : inputs loaded in vis1 [and vis2]</span>
<span class="sd">    pstns0 : positions of inputs as obtained from the layout database</span>
<span class="sd">    bsipts : base inputs used to determine cross correlations loaded</span>
<span class="sd">             (might become unecessary in the future)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">vis1</span><span class="p">,</span>
        <span class="n">vis2</span><span class="p">,</span>
        <span class="n">tm1</span><span class="p">,</span>
        <span class="n">tm2</span><span class="p">,</span>
        <span class="n">src1</span><span class="p">,</span>
        <span class="n">src2</span><span class="p">,</span>
        <span class="n">freqs</span><span class="p">,</span>
        <span class="n">prods</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">,</span>
        <span class="n">pstns0</span><span class="p">,</span>
        <span class="n">bsipts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Basic initialization method&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adj_freqs</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># frequencies adjacent in data? (used for some tests)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PATH</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># True if Pathfinder, False if CHIME</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vis1</span> <span class="o">=</span> <span class="n">vis1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vis2</span> <span class="o">=</span> <span class="n">vis2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tm1</span> <span class="o">=</span> <span class="n">tm1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tm2</span> <span class="o">=</span> <span class="n">tm2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span> <span class="o">=</span> <span class="n">freqs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prods</span> <span class="o">=</span> <span class="n">prods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inprds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">prod</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">prod</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span> <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prods</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstns0</span> <span class="o">=</span> <span class="n">pstns0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bsipts</span> <span class="o">=</span> <span class="n">bsipts</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Nfr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Npr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prods</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nip</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_bslns0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bslns0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_bslns0</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source1</span> <span class="o">=</span> <span class="n">src1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source2</span> <span class="o">=</span> <span class="n">src2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source1</span><span class="o">.</span><span class="n">_dec</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source2</span><span class="o">.</span><span class="n">_dec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tt1</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">chime</span><span class="o">.</span><span class="n">transit_times</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tm1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tm1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">TTCORR</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source1</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tt2</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">chime</span><span class="o">.</span><span class="n">transit_times</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tm2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">tm2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">TTCORR</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source2</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Results place holders:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pass_xd1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_xd2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pass_cont1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_cont2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">good_prods</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">good_prods_cons</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs_cons</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># TODO: delete all incidences of self.dists_computed. Subs by</span>
        <span class="c1"># initializing here to self.xdists1 = None, etc..</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dists_computed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># TODO: this might not be used...</span>
        <span class="c1"># Possible to scramble expected baselines. For debug purposes only:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bslins0_scrambled</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_bslns0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">prods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prods</span>
        <span class="n">pstns0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstns0</span>

        <span class="n">c_bslns0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Npr</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">bslns0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Npr</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">prd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prods</span><span class="p">):</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">pstns0</span><span class="p">[</span><span class="n">prd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">pstns0</span><span class="p">[</span><span class="n">prd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">pstns0</span><span class="p">[</span><span class="n">prd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">pstns0</span><span class="p">[</span><span class="n">prd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Expected baselines (cylinder coords):</span>
            <span class="n">c_bslns0</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x0</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">y1</span><span class="p">])</span>
            <span class="c1"># Expected rotated baselines (Earth coords):</span>
            <span class="n">bslns0</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">c_bslns0</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">c_bslns0</span><span class="p">,</span> <span class="n">bslns0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">phase_trans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">tt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">ph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nfr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Npr</span><span class="p">))</span>
        <span class="n">tridx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tm</span> <span class="o">-</span> <span class="n">tt</span><span class="p">))</span>  <span class="c1"># Transit index</span>

        <span class="c1"># TODO: Could add a test to check if transit time falls</span>
        <span class="c1"># in between time points (rather than close to a particular point)</span>
        <span class="c1"># and take a wheighted average of the two points in this case:</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nfr</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Npr</span><span class="p">):</span>
                <span class="n">ph</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">tridx</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">ph</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">getphases_tr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ph1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vis1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tm1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tt1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ph2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_trans</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vis2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tm2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tt2</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2</span>

<div class="viewcode-block" id="FeedLocator.get_c_ydist">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.FeedLocator.get_c_ydist">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_c_ydist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ph1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ph2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">good_freqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">Nmax</span><span class="o">=</span><span class="mi">20</span>
    <span class="p">):</span>  <span class="c1"># knl=3,dfacts=[5,11,17],rms_tol=1.):#,stptol=1.5,stpdev=1.):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;N-S. Absolutelly assumes contiguous frequencies!!!&quot;&quot;&quot;</span>
        <span class="c1"># TODO: add test for contiguous freqs!!!</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">yparams</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">ydiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">xdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
            <span class="n">absydiff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ydiff</span><span class="p">)</span>

            <span class="n">m</span><span class="p">,</span> <span class="n">mn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">yy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">yy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ydiff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">slct</span> <span class="o">=</span> <span class="n">absydiff</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">tol</span>
                <span class="n">m</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">ydiff</span><span class="p">[</span><span class="n">slct</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">/</span> <span class="n">xdiff</span><span class="p">[</span><span class="n">slct</span><span class="p">])</span>
                <span class="n">mn</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ydiff</span><span class="p">[</span><span class="n">slct</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">/</span> <span class="n">xdiff</span><span class="p">[</span><span class="n">slct</span><span class="p">])</span>

            <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="n">xx</span> <span class="o">-</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">slp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="o">+</span> <span class="n">yy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="k">for</span> <span class="n">slp</span> <span class="ow">in</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">mn</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># Options are:</span>
            <span class="c1"># fit-slope-no-unwrap, median-slope-no-unwrap, mean-slope-no-unwrap</span>
            <span class="c1"># the same three again with unwrapping and discont=2.*np.pi-tol</span>
            <span class="c1"># the same three again with unwrapping and no discont</span>
            <span class="n">y_opts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">9</span><span class="p">,</span> <span class="n">yy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">y_opts</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">-</span> <span class="n">lines</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">y_opts</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">y_opts</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">discont</span><span class="o">=</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">tol</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y_opts</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">y_opts</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Get goodness of fit:</span>
            <span class="n">y_rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">y_opts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_opts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_opts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="n">y_opts</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">y_rms</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">opt</span> <span class="o">-</span> <span class="n">mod</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">y_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">y_rms</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">y_opts</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_opts</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">lines</span>
            <span class="n">y_opts</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_opts</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">lines</span>
            <span class="n">y_opts</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span> <span class="o">=</span> <span class="n">y_opts</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span> <span class="o">+</span> <span class="n">lines</span>
            <span class="n">y_nxt</span> <span class="o">=</span> <span class="n">y_opts</span><span class="p">[</span>
                <span class="n">y_idx</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_opts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_opts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">]</span>

            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">y_nxt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">y_nxt</span><span class="p">,</span> <span class="n">a</span>

        <span class="k">if</span> <span class="n">ph1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph1</span>
        <span class="k">if</span> <span class="n">ph2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2</span>

        <span class="n">yslope</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ph1</span> <span class="o">-</span> <span class="n">ph2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="k">if</span> <span class="n">good_freqs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yslope</span> <span class="o">=</span> <span class="n">yslope</span><span class="p">[</span><span class="n">good_freqs</span><span class="p">]</span>
            <span class="n">fr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">[</span><span class="n">good_freqs</span><span class="p">])</span>

        <span class="n">yslope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">yslope</span><span class="p">,</span> <span class="n">discont</span><span class="o">=</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">tol</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">yslope</span> <span class="o">=</span> <span class="n">yslope</span> <span class="o">-</span> <span class="n">yslope</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">yslp</span><span class="p">,</span> <span class="n">a_prev</span> <span class="o">=</span> <span class="n">yparams</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">yslope</span><span class="p">)</span>  <span class="c1"># First iteration</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nmax</span><span class="p">):</span>
            <span class="n">yslp</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">yparams</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">yslp</span><span class="p">)</span>
            <span class="n">a_incr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">a_prev</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">a_prev</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a_incr</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">break</span>

            <span class="n">a_prev</span> <span class="o">=</span> <span class="n">a</span>

        <span class="c1"># TODO: now it&#39;s only one per chan. Change rotation coda appropriatelly</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">a</span>
            <span class="o">/</span> <span class="mf">1e6</span>
            <span class="o">*</span> <span class="n">C</span>
            <span class="o">/</span> <span class="p">(</span>
                <span class="mf">2.0</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span> <span class="o">+</span> <span class="n">PHI</span><span class="p">)</span>
                    <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span> <span class="o">+</span> <span class="n">PHI</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="FeedLocator.get_c_ydist_perfreq">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.FeedLocator.get_c_ydist_perfreq">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_c_ydist_perfreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ph1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ph2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Old N-S dists function. TO be used only in case a continuum of</span>
<span class="sd">        frequencies is not available</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">ph1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph1</span>
        <span class="k">if</span> <span class="n">ph2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ph2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph2</span>

        <span class="n">c_ydists0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_bslns0</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">dist_period</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
            <span class="n">C</span>
            <span class="o">/</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span>
                <span class="o">*</span> <span class="mf">1e6</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span> <span class="o">+</span> <span class="n">PHI</span><span class="p">)</span>
                    <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span> <span class="o">+</span> <span class="n">PHI</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">exp_dist</span> <span class="o">=</span> <span class="n">c_ydists0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">%</span> <span class="n">dist_period</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">base_ctr</span> <span class="o">=</span> <span class="n">c_ydists0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">exp_dist</span>
        <span class="n">base_up</span> <span class="o">=</span> <span class="n">base_ctr</span> <span class="o">+</span> <span class="n">dist_period</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">base_down</span> <span class="o">=</span> <span class="n">base_ctr</span> <span class="o">-</span> <span class="n">dist_period</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

        <span class="n">phdiff</span> <span class="o">=</span> <span class="n">ph1</span> <span class="o">-</span> <span class="n">ph2</span>
        <span class="n">c_ydists</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">phdiff</span>
            <span class="o">*</span> <span class="n">C</span>
            <span class="o">/</span> <span class="p">(</span>
                <span class="mf">2.0</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="o">*</span> <span class="mf">1e6</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span> <span class="o">+</span> <span class="n">PHI</span><span class="p">)</span>
                    <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span> <span class="o">+</span> <span class="n">PHI</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">c_ydists</span> <span class="o">=</span> <span class="n">c_ydists</span> <span class="o">%</span> <span class="n">dist_period</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">dist_opts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">c_ydists</span> <span class="o">+</span> <span class="n">base_up</span><span class="p">,</span> <span class="n">c_ydists</span> <span class="o">+</span> <span class="n">base_ctr</span><span class="p">,</span> <span class="n">c_ydists</span> <span class="o">+</span> <span class="n">base_down</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dist_opts</span> <span class="o">-</span> <span class="n">c_ydists0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="n">dist_opts</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">],</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Npr</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nfr</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span></div>


    <span class="c1"># TODO: change to &#39;yparams&#39;</span>
<div class="viewcode-block" id="FeedLocator.params_ft">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.FeedLocator.params_ft">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">params_ft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">x0_shift</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract relevant parameters from source transit</span>
<span class="sd">            visibility in two steps:</span>
<span class="sd">                1) FFT visibility</span>
<span class="sd">                2) Fit a gaussian to the transform</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tm : array-like</span>
<span class="sd">            Independent variable (time)</span>
<span class="sd">        trace : array-like</span>
<span class="sd">            Dependent variable (visibility)</span>
<span class="sd">        freq : float</span>
<span class="sd">            Frenquency of the visibility trace, in MHz.</span>
<span class="sd">        dec : float</span>
<span class="sd">            Declination of source. Used for initial guess of</span>
<span class="sd">            gaussian width. Defaults to CygA declination: 0.71</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        popt : array of float</span>
<span class="sd">            List with optimal parameters: [A,mu,sig2]</span>
<span class="sd">        pcov : array of float</span>
<span class="sd">            Covariance matrix for optimal parameters.</span>
<span class="sd">            For details see documentation on numpy.curve_fit</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>

        <span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span>

        <span class="c1"># Gaussian function for fit:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">gaus</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sig2</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">sig2</span><span class="p">))</span>

        <span class="c1"># FFT:</span>
        <span class="c1"># TODO: add check to see if length is multiple of 2</span>
        <span class="n">Nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tm</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">tm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">Nt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
        <span class="c1"># Re-order frequencies:</span>
        <span class="n">ft_ord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">ft</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Nt</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Nt</span> <span class="o">%</span> <span class="mi">2</span> <span class="p">:],</span> <span class="n">ft</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span> <span class="n">Nt</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Nt</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">ft_ord</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ft_ord</span><span class="p">)</span>
        <span class="n">fr_ord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">fr</span><span class="p">[</span><span class="n">Nt</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Nt</span> <span class="o">%</span> <span class="mi">2</span> <span class="p">:],</span> <span class="n">fr</span><span class="p">[:</span> <span class="n">Nt</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Nt</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]))</span>

        <span class="c1"># Gaussian fits:</span>
        <span class="c1"># Initial guesses:</span>
        <span class="c1"># distx_0 = self.bslns0[:,0] # Should all be either 0 or +-22 for Pathfinder</span>
        <span class="n">x0_shift</span> <span class="o">=</span> <span class="mf">5.0</span>
        <span class="n">distx_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bslns0</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x0_shift</span>  <span class="c1"># Shift to test robustness</span>
        <span class="n">mu0</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="mf">2.0</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="o">*</span> <span class="n">freqs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="o">*</span> <span class="mf">1e6</span>
            <span class="o">*</span> <span class="n">distx_0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">dec</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="mf">3e8</span> <span class="o">*</span> <span class="n">SD</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ctr_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">fr_ord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">mu0</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">A0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="n">ft_ord</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">ctr_idx</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]]</span> <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Npr</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nfr</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># 1 deg =&gt; dt = 1*(pi/180)*(24*3600/2*pi) = 240s</span>
        <span class="n">sigsqr0</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">240.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[[</span><span class="n">A0</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">],</span> <span class="n">mu0</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">],</span> <span class="n">sigsqr0</span><span class="p">]</span> <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Npr</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nfr</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Perform fit:</span>
        <span class="c1"># TODO: there must be a way to do the fits without the for-loops</span>
        <span class="n">prms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Nfr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Npr</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nfr</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Npr</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">gaus</span><span class="p">,</span> <span class="n">fr_ord</span><span class="p">,</span> <span class="n">ft_ord</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="p">:],</span> <span class="n">p0</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">])</span>
                    <span class="n">prms</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">popt</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="c1"># TODO: Use masked arrays instead of None?</span>
                    <span class="n">prms</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>

        <span class="k">return</span> <span class="n">prms</span></div>


    <span class="c1"># TODO: change to &#39;get_yparams&#39;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">getparams_ft</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Add test to eliminate bad fits!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ft_prms1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_ft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tm1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ft_prms2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_ft</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tm2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ft_prms2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft_prms1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft_prms2</span>

    <span class="c1"># TODO: change all occurences of &#39;get_xdist&#39; to &#39;xdists&#39;</span>
    <span class="c1"># to make it more consistent</span>
<div class="viewcode-block" id="FeedLocator.get_xdist">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.FeedLocator.get_xdist">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_xdist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ft_prms</span><span class="p">,</span> <span class="n">dec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;E-W&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">ft_prms</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">SD</span>
            <span class="o">*</span> <span class="n">C</span>
            <span class="o">/</span> <span class="p">(</span>
                <span class="mf">2.0</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="o">*</span> <span class="mf">1e6</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">dec</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">data_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_xd1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xdist_test</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">c_xdists1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_xdists2</span>
                <span class="p">)</span>  <span class="c1"># Assigns self.pass_xd1, self.pass_xd2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Slightly higher tolerance since it uses rotated dists</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xdist_test</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdists1</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_cont1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">continuity_test</span><span class="p">()</span>  <span class="c1"># Assigns self.pass_cont1 and self.pass_cont2</span>

        <span class="n">gpxd1</span><span class="p">,</span> <span class="n">gfxd1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_prod_freq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_xd1</span><span class="p">)</span>
        <span class="n">gpc1</span><span class="p">,</span> <span class="n">gfc1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_prod_freq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_cont1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gpxd2</span><span class="p">,</span> <span class="n">gfxd2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_prod_freq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_xd2</span><span class="p">)</span>
            <span class="n">gpc2</span><span class="p">,</span> <span class="n">gfc2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_prod_freq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_cont2</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">good_prods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">gpc1</span><span class="p">,</span> <span class="n">gpc2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">gpxd1</span><span class="p">,</span> <span class="n">gpxd2</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># good prods</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">gfc1</span><span class="p">,</span> <span class="n">gfc2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">gfxd1</span><span class="p">,</span> <span class="n">gfxd2</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># good freqs</span>

            <span class="c1"># TODO: Delete these conservative estimates?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">good_prods_cons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">gpc1</span><span class="p">,</span> <span class="n">gpc2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">gpxd1</span><span class="p">,</span> <span class="n">gpxd2</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># Conservative good prods</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs_cons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">gfc1</span><span class="p">,</span> <span class="n">gfc2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">gfxd1</span><span class="p">,</span> <span class="n">gfxd2</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># Conservative good freqs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">good_prods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">gpc1</span><span class="p">,</span> <span class="n">gpxd1</span><span class="p">)</span>  <span class="c1"># good prods</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">gfc1</span><span class="p">,</span> <span class="n">gfxd1</span><span class="p">)</span>  <span class="c1"># good freqs</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsipts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_good_ipts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bsipts</span><span class="p">)</span>  <span class="c1"># good_prods to good_ipts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">single_source_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getparams_ft</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xdists1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xdist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ft_prms1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_quality</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_dists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="c1"># Get x distances in Earth coords (EW)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getparams_ft</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xdists1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xdist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ft_prms1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xdists2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xdist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ft_prms2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span><span class="p">)</span>
        <span class="c1"># Preliminary test for bad freqs (needed for ydists):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_cont1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">continuity_test</span><span class="p">()</span>  <span class="c1"># Assigns self.pass_cont1 and self.pass_cont2</span>
        <span class="n">gpc1</span><span class="p">,</span> <span class="n">gfc1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_prod_freq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_cont1</span><span class="p">)</span>
        <span class="n">gpc2</span><span class="p">,</span> <span class="n">gfc2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_prod_freq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pass_cont2</span><span class="p">)</span>
        <span class="n">gf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">gfc1</span><span class="p">,</span> <span class="n">gfc2</span><span class="p">)</span>  <span class="c1"># Preliminary good freqs</span>
        <span class="c1"># Get y distances in cylinder coordinates (NS rotated by 2 deg)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getphases_tr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_ydists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_c_ydist</span><span class="p">(</span><span class="n">good_freqs</span><span class="o">=</span><span class="n">gf</span><span class="p">)</span>
        <span class="c1"># Transform between Earth and cylinder coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_xdists1</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xdists1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_ydists</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">CR</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">CR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_xdists2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xdists2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_ydists</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">CR</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">CR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydists1</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xdists1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_ydists</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">CR</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">CR</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_ydists</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">CR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydists2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xdists2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_ydists</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">CR</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">CR</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_ydists</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">CR</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dists_computed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_quality</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_xdists1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_xdists2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_ydists</span>

<div class="viewcode-block" id="FeedLocator.set_good_ipts">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.FeedLocator.set_good_ipts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_good_ipts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_ipts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Good_prods to good_ipts&quot;&quot;&quot;</span>
        <span class="n">inp_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span>  <span class="c1"># Full input list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">good_ipts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">inprd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inprds</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">inprd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_ipts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">[</span><span class="n">inp_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">inprd</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_prods</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">inprd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_ipts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">[</span><span class="n">inp_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">inprd</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_prods</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">inprd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">base_ipts</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">inprd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">base_ipts</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">[</span><span class="n">inp_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">inprd</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_prods</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">[</span><span class="n">inp_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">inprd</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_prods</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="c1"># To make sure base inputs are tagged good:</span>
        <span class="k">for</span> <span class="n">bsip</span> <span class="ow">in</span> <span class="n">base_ipts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">[</span><span class="n">inp_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">bsip</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">solv_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dists</span><span class="p">,</span> <span class="n">base_ipt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.linalg</span><span class="w"> </span><span class="kn">import</span> <span class="n">svd</span>

        <span class="c1"># Matrix defining order of subtraction for baseline distances</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Npr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nip</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Remove base_ipt as its position will be set to zero</span>
        <span class="n">sht_inp_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">inpt</span> <span class="k">for</span> <span class="n">inpt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="k">if</span> <span class="n">inpt</span> <span class="o">!=</span> <span class="n">base_ipt</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">inprd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inprds</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">inprd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">base_ipt</span><span class="p">:</span>
                <span class="n">M</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">sht_inp_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">inprd</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">if</span> <span class="n">inprd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">base_ipt</span><span class="p">:</span>
                <span class="n">M</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">sht_inp_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">inprd</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Vh</span> <span class="o">=</span> <span class="n">svd</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        <span class="c1"># TODO: add test for small s values to zero. Check existing code for that.</span>
        <span class="c1"># Pseudo-inverse:</span>
        <span class="n">psd_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Vh</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">s</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>
        <span class="c1"># Positions:</span>
        <span class="n">pstns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">psd_inv</span><span class="p">,</span> <span class="n">dists</span><span class="p">)</span>
        <span class="c1"># Add position of base_input</span>
        <span class="n">inp_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span>  <span class="c1"># Full input list</span>
        <span class="n">bs_inpt_idx</span> <span class="o">=</span> <span class="n">inp_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">base_ipt</span><span class="p">)</span>  <span class="c1"># Original index of base_ipt</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pstns</span><span class="p">,</span> <span class="n">bs_inpt_idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_postns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_xd1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_xdists1</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_xd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_xdists2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Solve positions:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solv_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_ydists</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsipts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solv_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_xd1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsipts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solv_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_xd2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsipts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solv_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_bslns0</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsipts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solv_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c_bslns0</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsipts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_y</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">xdist_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xds1</span><span class="p">,</span> <span class="n">xds2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">2.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_centre</span><span class="p">(</span><span class="n">xdists</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Returns the median (across frequencies) of NS separation dists for each</span>
<span class="sd">            baseline if this median is withing *tol* of a multiple of 22 meters. Else,</span>
<span class="sd">            returns the multiple of 22 meters closest to this median (up to 3*22=66</span>
<span class="sd">            meters)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">xmeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">xdists</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cylseps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">22.0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PATH</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mf">22.0</span>
            <span class="n">devs</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xmeds</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">cylseps</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">devmins</span> <span class="o">=</span> <span class="n">devs</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="n">xmeds</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>  <span class="c1"># return median</span>
                        <span class="k">if</span> <span class="n">devmins</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tol</span>  <span class="c1"># if reasonable</span>
                        <span class="k">else</span> <span class="n">cylseps</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">devs</span><span class="p">[</span><span class="n">ii</span><span class="p">])]</span>
                    <span class="p">)</span>  <span class="c1"># or use closest value</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">devmins</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="n">xcentre1</span> <span class="o">=</span> <span class="n">get_centre</span><span class="p">(</span><span class="n">xds1</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">xerr1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xds1</span> <span class="o">-</span> <span class="n">xcentre1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pass_xd1</span> <span class="o">=</span> <span class="n">xerr1</span> <span class="o">&lt;</span> <span class="n">tol</span>

        <span class="k">if</span> <span class="n">xds2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xcentre2</span> <span class="o">=</span> <span class="n">get_centre</span><span class="p">(</span><span class="n">xds2</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
            <span class="n">xerr2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xds2</span> <span class="o">-</span> <span class="n">xcentre2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pass_xd2</span> <span class="o">=</span> <span class="n">xerr2</span> <span class="o">&lt;</span> <span class="n">tol</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pass_xd2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_xd1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_xd2</span>

<div class="viewcode-block" id="FeedLocator.continuity_test">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.FeedLocator.continuity_test">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">continuity_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">knl</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call only if freqs are adjacent.</span>
<span class="sd">        Uses xdists (Earth coords) instead of c_xdists (cylinder coords)</span>
<span class="sd">        to allow for calling before ydists are computed. Doesn&#39;t make any</span>
<span class="sd">        difference for this test. Results are used in computing y_dists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">medfilt</span>

        <span class="n">clean_xdists1</span> <span class="o">=</span> <span class="n">medfilt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdists1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">[</span><span class="n">knl</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">diffs1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdists1</span> <span class="o">-</span> <span class="n">clean_xdists1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pass_cont1</span> <span class="o">=</span> <span class="n">diffs1</span> <span class="o">&lt;</span> <span class="n">tol</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clean_xdists2</span> <span class="o">=</span> <span class="n">medfilt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdists2</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">[</span><span class="n">knl</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">diffs2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdists2</span> <span class="o">-</span> <span class="n">clean_xdists2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pass_cont2</span> <span class="o">=</span> <span class="n">diffs2</span> <span class="o">&lt;</span> <span class="n">tol</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pass_cont2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_cont1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_cont2</span></div>


<div class="viewcode-block" id="FeedLocator.good_prod_freq">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.FeedLocator.good_prod_freq">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">good_prod_freq</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pass_rst</span><span class="p">,</span> <span class="n">tol_ch1</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">tol_ch2</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">tol_fr1</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">tol_fr2</span><span class="o">=</span><span class="mf">0.7</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tries to determine overall bad products and overall bad frequencies</span>
<span class="sd">        from a test_pass result.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># First iteration:</span>
        <span class="n">chans_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pass_rst</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">pass_rst</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">freqs_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pass_rst</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">pass_rst</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">good_chans</span> <span class="o">=</span> <span class="n">chans_score</span> <span class="o">&gt;</span> <span class="n">tol_ch1</span>
        <span class="n">good_freqs</span> <span class="o">=</span> <span class="n">freqs_score</span> <span class="o">&gt;</span> <span class="n">tol_fr1</span>
        <span class="c1"># Second Iteration:</span>
        <span class="n">pass_gch</span> <span class="o">=</span> <span class="n">pass_rst</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_chans</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># Only good channels</span>
        <span class="n">pass_gfr</span> <span class="o">=</span> <span class="n">pass_rst</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_freqs</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span>  <span class="c1"># Only good freqs</span>
        <span class="n">chans_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pass_gfr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">pass_gfr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">freqs_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pass_gch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">pass_gch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">good_chans</span> <span class="o">=</span> <span class="n">chans_score</span> <span class="o">&gt;</span> <span class="n">tol_ch2</span>
        <span class="n">good_freqs</span> <span class="o">=</span> <span class="n">freqs_score</span> <span class="o">&gt;</span> <span class="n">tol_fr2</span>

        <span class="k">return</span> <span class="n">good_chans</span><span class="p">,</span> <span class="n">good_freqs</span></div>
</div>



<div class="viewcode-block" id="ChanMonitor">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.ChanMonitor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ChanMonitor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class provides the user interface to FeedLocator.</span>

<span class="sd">    It initializes instances of FeedLocator (normally one per polarization)</span>
<span class="sd">    and returns results combined lists of results (good channels and positions,</span>
<span class="sd">    agreement/disagreement with the layout database, etc.)</span>

<span class="sd">    Feed locator should not</span>
<span class="sd">    have to sepparate the visibilities in data to run the test on and data</span>
<span class="sd">    not to run the test on. ChanMonitor should make the sepparation and</span>
<span class="sd">    provide FeedLocator with the right data cube to test.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t1 [t2] : Initial [final] time for the test period. If t2 not provided it is</span>
<span class="sd">              set to 1 sideral day after t1</span>
<span class="sd">    freq_sel</span>
<span class="sd">    prod_sel</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">t1</span><span class="p">,</span>
        <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">freq_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prod_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bswp1</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span>
        <span class="n">bswp2</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
        <span class="n">bsep1</span><span class="o">=</span><span class="mi">154</span><span class="p">,</span>
        <span class="n">bsep2</span><span class="o">=</span><span class="mi">218</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Here t1 and t2 have to be unix time (floats)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t1</span> <span class="o">=</span> <span class="n">t1</span>
        <span class="k">if</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span> <span class="o">+</span> <span class="n">SD</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> <span class="n">t2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">acq_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">night_acq_list</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">finder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">night_finder</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#        if prod_sel is not None:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prod_sel</span> <span class="o">=</span> <span class="n">prod_sel</span>
        <span class="c1">#        if freq_sel is not None:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_sel</span> <span class="o">=</span> <span class="n">freq_sel</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dat1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dat2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tm1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tm2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prods</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">corr_inputs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pwds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstns</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p1_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p2_idx</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bswp1</span> <span class="o">=</span> <span class="n">bswp1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bsep1</span> <span class="o">=</span> <span class="n">bsep1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bswp2</span> <span class="o">=</span> <span class="n">bswp2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bsep2</span> <span class="o">=</span> <span class="n">bsep2</span>

<div class="viewcode-block" id="ChanMonitor.fromdate">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.ChanMonitor.fromdate">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fromdate</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">date</span><span class="p">,</span>
        <span class="n">freq_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prod_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bswp1</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span>
        <span class="n">bswp2</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
        <span class="n">bsep1</span><span class="o">=</span><span class="mi">154</span><span class="p">,</span>
        <span class="n">bsep2</span><span class="o">=</span><span class="mi">218</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize class from date&quot;&quot;&quot;</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">datetime_to_unix</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">t1</span><span class="p">,</span>
            <span class="n">freq_sel</span><span class="o">=</span><span class="n">freq_sel</span><span class="p">,</span>
            <span class="n">prod_sel</span><span class="o">=</span><span class="n">prod_sel</span><span class="p">,</span>
            <span class="n">bswp1</span><span class="o">=</span><span class="n">bswp1</span><span class="p">,</span>
            <span class="n">bswp2</span><span class="o">=</span><span class="n">bswp2</span><span class="p">,</span>
            <span class="n">bsep1</span><span class="o">=</span><span class="n">bsep1</span><span class="p">,</span>
            <span class="n">bsep2</span><span class="o">=</span><span class="n">bsep2</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="c1"># TODO: this is kind of silly right now.</span>
    <span class="c1"># If it is initialized from data, I should use the data given</span>
    <span class="c1"># or not allow for that possibility.</span>
<div class="viewcode-block" id="ChanMonitor.fromdata">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.ChanMonitor.fromdata">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fromdata</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">freq_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prod_sel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize class from andata object&quot;&quot;&quot;</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">freq_sel</span><span class="o">=</span><span class="n">freq_sel</span><span class="p">,</span> <span class="n">prod_sel</span><span class="o">=</span><span class="n">prod_sel</span><span class="p">)</span></div>


    <span class="c1"># TODO: test for adjacent freqs to pass to FeedLocator</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_src_cndts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">clr</span><span class="p">,</span> <span class="n">ntt</span><span class="p">,</span> <span class="n">srcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sunfree_srcs</span><span class="p">()</span>

        <span class="n">grd_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;CygA&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;CasA&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;TauA&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;VirA&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="c1"># Grades for each source</span>
        <span class="n">grds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">grd_dict</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CygA&quot;</span><span class="p">,</span> <span class="s2">&quot;CasA&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ntt</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="p">)</span>  <span class="c1"># CasA and CygA at daytime worse than TauA at night</span>
                <span class="k">else</span> <span class="n">grd_dict</span><span class="p">[</span><span class="n">src</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">srcs</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Grade 0 if not clear of Sun:</span>
        <span class="n">grds</span> <span class="o">=</span> <span class="p">[</span><span class="n">grd</span> <span class="k">if</span> <span class="n">clr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">grd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grds</span><span class="p">)]</span>

        <span class="c1"># Source candidates ordered in decreasing quality</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">src</span>
            <span class="k">for</span> <span class="n">grd</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">grds</span><span class="p">,</span> <span class="n">srcs</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">grd</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_pol_prod_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pol_inpt_idx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">pol_prod_idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">prd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prods</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">prd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pol_inpt_idx</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">pol_inpt_idx</span><span class="p">):</span>
                <span class="n">pol_prod_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pol_prod_idx</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_feedlocator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pol_inpt_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1_idx</span>
            <span class="n">bsipts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bswp1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsep1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">pol_inpt_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p2_idx</span>
            <span class="n">bsipts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bswp2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsep2</span><span class="p">]</span>

        <span class="n">pol_prod_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pol_prod_idx</span><span class="p">(</span><span class="n">pol_inpt_idx</span><span class="p">)</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">pol_inpt_idx</span><span class="p">]</span>
        <span class="n">pstns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pstns</span><span class="p">[</span><span class="n">pol_inpt_idx</span><span class="p">]</span>
        <span class="n">prods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">prd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prods</span><span class="p">[</span><span class="n">pol_prod_idx</span><span class="p">]:</span>
            <span class="n">idx0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inputs</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">prd</span><span class="p">[</span><span class="mi">0</span><span class="p">]])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">inputs</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">prd</span><span class="p">[</span><span class="mi">1</span><span class="p">]])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prods</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">idx0</span><span class="p">,</span> <span class="n">idx1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="n">FeedLocator</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dat1</span><span class="o">.</span><span class="n">vis</span><span class="p">[:,</span> <span class="n">pol_prod_idx</span><span class="p">,</span> <span class="p">:],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dat2</span><span class="o">.</span><span class="n">vis</span><span class="p">[:,</span> <span class="n">pol_prod_idx</span><span class="p">,</span> <span class="p">:],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tm1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tm2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">,</span>
                <span class="n">prods</span><span class="p">,</span>
                <span class="n">inputs</span><span class="p">,</span>
                <span class="n">pstns</span><span class="p">,</span>
                <span class="n">bsipts</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fl</span> <span class="o">=</span> <span class="n">FeedLocator</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dat1</span><span class="o">.</span><span class="n">vis</span><span class="p">[:,</span> <span class="n">pol_prod_idx</span><span class="p">,</span> <span class="p">:],</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tm1</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span><span class="p">,</span>
                <span class="n">prods</span><span class="p">,</span>
                <span class="n">inputs</span><span class="p">,</span>
                <span class="n">pstns</span><span class="p">,</span>
                <span class="n">bsipts</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">fl</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_feedloc_p1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flp1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feedlocator</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">flp1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_feedloc_p2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_feedlocator</span><span class="p">(</span><span class="n">pol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">flp2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_cyl_pol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corr_inputs</span><span class="p">,</span> <span class="n">pwds</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">wchp1</span><span class="p">,</span> <span class="n">wchp2</span><span class="p">,</span> <span class="n">echp1</span><span class="p">,</span> <span class="n">echp2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">inpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corr_inputs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pwds</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">inpt</span><span class="o">.</span><span class="n">reflector</span> <span class="o">==</span> <span class="s2">&quot;W_cylinder&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inpt</span><span class="o">.</span><span class="n">pol</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span>
                        <span class="n">wchp1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">wchp2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">inpt</span><span class="o">.</span><span class="n">reflector</span> <span class="o">==</span> <span class="s2">&quot;E_cylinder&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inpt</span><span class="o">.</span><span class="n">pol</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span>
                        <span class="n">echp1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">echp2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># This probably doesn&#39;t happen...</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: this only makes sense for the pathfinder:</span>
                <span class="k">if</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">:</span>
                    <span class="n">wchp1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">:</span>
                    <span class="n">wchp2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">192</span><span class="p">:</span>
                    <span class="n">echp1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">echp2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">wchp1</span><span class="p">,</span> <span class="n">wchp2</span><span class="p">,</span> <span class="n">echp1</span><span class="p">,</span> <span class="n">echp2</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_pos_pol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corr_inputs</span><span class="p">,</span> <span class="n">pwds</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">Ninpts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pwds</span><span class="p">)</span>
        <span class="n">p1_idx</span><span class="p">,</span> <span class="n">p2_idx</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">pstns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ninpts</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># In-cylinder positions</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">inpt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">corr_inputs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pwds</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                <span class="n">pstns</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inpt</span><span class="o">.</span><span class="n">cyl</span> <span class="o">*</span> <span class="mf">22.0</span>
                <span class="n">pstns</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">inpt</span><span class="o">.</span><span class="n">pos</span>
                <span class="k">if</span> <span class="n">inpt</span><span class="o">.</span><span class="n">pol</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span>
                    <span class="n">p1_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p2_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: this only makes sense for the pathfinder:</span>
                <span class="c1"># Numbers were taken from layout database</span>
                <span class="k">if</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">:</span>
                    <span class="n">pstns</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">pstns</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">8.767</span> <span class="o">-</span> <span class="mf">0.3048</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                    <span class="n">p1_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">:</span>
                    <span class="n">pstns</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">pstns</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">8.767</span> <span class="o">-</span> <span class="mf">0.3048</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span>
                    <span class="n">p2_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">192</span><span class="p">:</span>
                    <span class="n">pstns</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">22.0</span>
                    <span class="n">pstns</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">8.7124</span> <span class="o">-</span> <span class="mf">0.3048</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span>
                    <span class="n">p1_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pstns</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">22.0</span>
                    <span class="n">pstns</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">8.7124</span> <span class="o">-</span> <span class="mf">0.3048</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">ii</span> <span class="o">-</span> <span class="mi">192</span><span class="p">)</span>
                    <span class="n">p2_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pstns</span><span class="p">,</span> <span class="n">p1_idx</span><span class="p">,</span> <span class="n">p2_idx</span>

<div class="viewcode-block" id="ChanMonitor.set_metadata">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.ChanMonitor.set_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tms</span><span class="p">,</span> <span class="n">input_map</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets self.corr_inputs, self.pwds, self.pstns, self.p1_idx, self.p2_idx&quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">ch_util</span><span class="w"> </span><span class="kn">import</span> <span class="n">tools</span>

        <span class="c1"># Get CHIME ON channels:</span>
        <span class="n">half_time</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">unix_to_datetime</span><span class="p">(</span><span class="n">tms</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tms</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)])</span>
        <span class="n">corr_inputs</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_correlator_inputs</span><span class="p">(</span><span class="n">half_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr_inputs</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">reorder_correlator_inputs</span><span class="p">(</span><span class="n">input_map</span><span class="p">,</span> <span class="n">corr_inputs</span><span class="p">)</span>
        <span class="n">pwds</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">is_chime_on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_inputs</span><span class="p">)</span>  <span class="c1"># Which inputs are CHIME ON antennas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pwds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pwds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1"># Get cylinders and polarizations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pstns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p2_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pos_pol</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">corr_inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pwds</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">determine_bad_gpu_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">frac_time_on</span><span class="o">=</span><span class="mf">0.7</span><span class="p">):</span>
        <span class="n">node_on</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">vis</span><span class="p">[:]</span><span class="o">.</span><span class="n">real</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gpu_node_flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">node_on</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">frac_time_on</span> <span class="o">*</span> <span class="n">node_on</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_prod_sel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">ch_util</span><span class="w"> </span><span class="kn">import</span> <span class="n">tools</span>

        <span class="n">input_map</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">input</span>
        <span class="n">tms</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">time</span>
        <span class="n">half_time</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">unix_to_datetime</span><span class="p">(</span><span class="n">tms</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tms</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)])</span>
        <span class="n">corr_inputs</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_correlator_inputs</span><span class="p">(</span><span class="n">half_time</span><span class="p">)</span>
        <span class="n">corr_inputs</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">reorder_correlator_inputs</span><span class="p">(</span><span class="n">input_map</span><span class="p">,</span> <span class="n">corr_inputs</span><span class="p">)</span>
        <span class="n">pwds</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">is_chime_on</span><span class="p">(</span><span class="n">corr_inputs</span><span class="p">)</span>  <span class="c1"># Which inputs are CHIME ON antennas</span>

        <span class="n">wchp1</span><span class="p">,</span> <span class="n">wchp2</span><span class="p">,</span> <span class="n">echp1</span><span class="p">,</span> <span class="n">echp2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cyl_pol</span><span class="p">(</span><span class="n">corr_inputs</span><span class="p">,</span> <span class="n">pwds</span><span class="p">)</span>

        <span class="c1"># Ensure base channels are CHIME and ON</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">pwds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">input_map</span><span class="p">[</span><span class="s2">&quot;chan_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bswp1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bswp1</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">pwds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">input_map</span><span class="p">[</span><span class="s2">&quot;chan_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bswp2</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bswp2</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">pwds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">input_map</span><span class="p">[</span><span class="s2">&quot;chan_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsep1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bsep1</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">pwds</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">input_map</span><span class="p">[</span><span class="s2">&quot;chan_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsep2</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bsep2</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">prod_sel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">prod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">prod</span><span class="p">):</span>
            <span class="n">add_prod</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">add_prod</span> <span class="o">=</span> <span class="n">add_prod</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">prod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bswp1</span> <span class="ow">and</span> <span class="n">prod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">echp1</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">prod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bswp1</span> <span class="ow">and</span> <span class="n">prod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">echp1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">add_prod</span> <span class="o">=</span> <span class="n">add_prod</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">prod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bswp2</span> <span class="ow">and</span> <span class="n">prod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">echp2</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">prod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bswp2</span> <span class="ow">and</span> <span class="n">prod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">echp2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">add_prod</span> <span class="o">=</span> <span class="n">add_prod</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">prod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsep1</span> <span class="ow">and</span> <span class="n">prod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">wchp1</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">prod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsep1</span> <span class="ow">and</span> <span class="n">prod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">wchp1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">add_prod</span> <span class="o">=</span> <span class="n">add_prod</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">prod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsep2</span> <span class="ow">and</span> <span class="n">prod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">wchp2</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">prod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsep2</span> <span class="ow">and</span> <span class="n">prod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">wchp2</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">add_prod</span><span class="p">:</span>
                <span class="n">prod_sel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>

        <span class="n">prod_sel</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">prod_sel</span><span class="p">,</span> <span class="n">pwds</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">ch_util</span><span class="w"> </span><span class="kn">import</span> <span class="n">ni_utils</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_acq_list</span><span class="p">()</span>
        <span class="n">src_cndts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_src_cndts</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">src_cndts</span><span class="p">:</span>
            <span class="n">results_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Get prod_sel if not given:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Load data with a single frequency to get prod_sel</span>
                        <span class="n">dat</span> <span class="o">=</span> <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_loaded_data</span><span class="p">(</span><span class="n">freq_sel</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prod_sel</span><span class="p">,</span> <span class="n">pwds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prod_sel</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                    <span class="c1"># Load data:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source1</span> <span class="o">=</span> <span class="n">src</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dat1</span> <span class="o">=</span> <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_loaded_data</span><span class="p">(</span>
                        <span class="n">prod_sel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prod_sel</span><span class="p">,</span> <span class="n">freq_sel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_sel</span>
                    <span class="p">)</span>
                    <span class="c1"># TODO: correct process_synced_data to not crash when no NS</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dat1</span> <span class="o">=</span> <span class="n">ni_utils</span><span class="o">.</span><span class="n">process_synced_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dat1</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                        <span class="k">pass</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat1</span><span class="o">.</span><span class="n">freq</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat1</span><span class="o">.</span><span class="n">prod</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">input_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat1</span><span class="o">.</span><span class="n">input</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_map</span><span class="p">[</span><span class="s2">&quot;chan_id&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat1</span><span class="o">.</span><span class="n">time</span>
                    <span class="c1"># Set metadata (corr_inputs, pstns, polarizatins, etc...</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tm1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_map</span><span class="p">)</span>

                    <span class="c1"># Determine what frequencies are bad</span>
                    <span class="c1"># due to gpu nodes that are down</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">determine_bad_gpu_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dat1</span><span class="p">)</span>

                <span class="c1"># TODO: get corr_inputs for dat2 as well and compare to dat1</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source2</span> <span class="o">=</span> <span class="n">src</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dat2</span> <span class="o">=</span> <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_loaded_data</span><span class="p">(</span>
                        <span class="n">prod_sel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prod_sel</span><span class="p">,</span> <span class="n">freq_sel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_sel</span>
                    <span class="p">)</span>
                    <span class="c1"># TODO: correct process_synced_data to not crash when no NS</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dat2</span> <span class="o">=</span> <span class="n">ni_utils</span><span class="o">.</span><span class="n">process_synced_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dat2</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                        <span class="k">pass</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tm2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dat2</span><span class="o">.</span><span class="n">time</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source2</span>

<div class="viewcode-block" id="ChanMonitor.get_results">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.ChanMonitor.get_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">tdelt</span><span class="o">=</span><span class="mi">2800</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If self.finder exists, then it takes a deep copy of this object,</span>
<span class="sd">        further restricts the time range to include only src transits,</span>
<span class="sd">        and then queries the database to obtain a list of the acquisitions.</span>
<span class="sd">        If self.finder does not exist, then it creates a finder object,</span>
<span class="sd">        restricts the time range to include only src transits between</span>
<span class="sd">        self.t1 and self.t2, and then queries the database to obtain a list</span>
<span class="sd">        of the acquisitions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">finder</span><span class="o">.</span><span class="n">Finder</span><span class="p">(</span><span class="n">node_spoof</span><span class="o">=</span><span class="n">_DEFAULT_NODE_SPOOF</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">filter_acqs</span><span class="p">(</span><span class="n">data_index</span><span class="o">.</span><span class="n">ArchiveInst</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;pathfinder&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">only_corr</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">set_time_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">include_transits</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">time_delta</span><span class="o">=</span><span class="n">tdelt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span></div>


<div class="viewcode-block" id="ChanMonitor.set_acq_list">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.ChanMonitor.set_acq_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_acq_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method sets four attributes.  The first two attributes</span>
<span class="sd">        are &#39;night_finder&#39; and &#39;night_acq_list&#39;, which are the</span>
<span class="sd">        finder object and list of acquisitions that</span>
<span class="sd">        contain all night time data between self.t1 and self.t2.</span>
<span class="sd">        The second two attributes are &#39;finder&#39; and &#39;acq_list&#39;,</span>
<span class="sd">        which are the finder object and list of acquisitions</span>
<span class="sd">        that contain all data beween self.t1 and self.t2 with the</span>
<span class="sd">        sunrise, sun transit, and sunset removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create a Finder object and focus on time range</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">finder</span><span class="o">.</span><span class="n">Finder</span><span class="p">(</span><span class="n">node_spoof</span><span class="o">=</span><span class="n">_DEFAULT_NODE_SPOOF</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">filter_acqs</span><span class="p">(</span><span class="n">data_index</span><span class="o">.</span><span class="n">ArchiveInst</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;pathfinder&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">only_corr</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set_time_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">)</span>

        <span class="c1"># Create a list of acquisitions that only contain data collected at night</span>
        <span class="n">f_night</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f_night</span><span class="o">.</span><span class="n">exclude_daytime</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">night_finder</span> <span class="o">=</span> <span class="n">f_night</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">night_acq_list</span> <span class="o">=</span> <span class="n">f_night</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>

        <span class="c1"># Create a list of acquisitions that flag out sunrise, sun transit, and sunset</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">unix_to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">month</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">.</span><span class="n">unix_to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">day</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">mm</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">/</span> <span class="mf">30.0</span>

        <span class="n">fct</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="n">tol1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">mm</span> <span class="o">-</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">fct</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">10500.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mf">1500.0</span>
        <span class="n">tol2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">mm</span> <span class="o">-</span> <span class="mf">11.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">fct</span><span class="p">))</span> <span class="o">*</span> <span class="mf">10500.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mf">1500.0</span>
        <span class="n">ttol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">tol1</span><span class="p">,</span> <span class="n">tol2</span><span class="p">)</span>

        <span class="n">fct</span> <span class="o">=</span> <span class="mf">5.0</span>
        <span class="n">tol1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">mm</span> <span class="o">-</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">fct</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2100.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mf">6000.0</span>
        <span class="n">tol2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">mm</span> <span class="o">-</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">fct</span><span class="p">))</span> <span class="o">*</span> <span class="mf">2100.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mf">6000.0</span>
        <span class="n">rstol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">tol1</span><span class="p">,</span> <span class="n">tol2</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">exclude_sun</span><span class="p">(</span><span class="n">time_delta</span><span class="o">=</span><span class="n">ttol</span><span class="p">,</span> <span class="n">time_delta_rise_set</span><span class="o">=</span><span class="n">rstol</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">finder</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acq_list</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span></div>


<div class="viewcode-block" id="ChanMonitor.get_sunfree_srcs">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.ChanMonitor.get_sunfree_srcs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_sunfree_srcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method uses the attributes &#39;night_acq_list&#39; and</span>
<span class="sd">        &#39;acq_list&#39; to determine the srcs that transit</span>
<span class="sd">        in the available data.  If these attributes do not</span>
<span class="sd">        exist, then the method &#39;set_acq_list&#39; is called.</span>
<span class="sd">        If srcs is not specified, then it defaults to the</span>
<span class="sd">        brightest four radio point sources in the sky:</span>
<span class="sd">        CygA, CasA, TauA, and VirA.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_acq_list</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">srcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ch_ephem</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">CygA</span><span class="p">,</span>
                <span class="n">ch_ephem</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">CasA</span><span class="p">,</span>
                <span class="n">ch_ephem</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">TauA</span><span class="p">,</span>
                <span class="n">ch_ephem</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">VirA</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="n">Ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">srcs</span><span class="p">)</span>

        <span class="n">clr</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ns</span>
        <span class="n">ntt</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ns</span>  <span class="c1"># night transit</span>

        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">srcs</span><span class="p">):</span>
            <span class="n">night_transit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">night_acq_list</span><span class="p">:</span>
                <span class="n">night_transit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">night_transit</span><span class="p">,</span> <span class="n">chime</span><span class="o">.</span><span class="n">transit_times</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">acq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">night_transit</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="n">ntt</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CygA&quot;</span><span class="p">,</span> <span class="s2">&quot;CasA&quot;</span><span class="p">]:</span>
                <span class="n">transit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">acq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_list</span><span class="p">:</span>
                    <span class="n">transit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transit</span><span class="p">,</span> <span class="n">chime</span><span class="o">.</span><span class="n">transit_times</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">acq</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                <span class="k">if</span> <span class="n">transit</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="n">clr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">clr</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntt</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">clr</span><span class="p">,</span> <span class="n">ntt</span><span class="p">,</span> <span class="n">srcs</span></div>


<div class="viewcode-block" id="ChanMonitor.single_source_check">
<a class="viewcode-back" href="../../_autosummary/ch_util.chan_monitor.html#ch_util.chan_monitor.ChanMonitor.single_source_check">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">single_source_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assumes self.source1 is NOT None&quot;&quot;&quot;</span>
        <span class="n">Nipts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">good_ipts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nipts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p1_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_feedloc_p1</span><span class="p">()</span>  <span class="c1"># Initiate FeedLocator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flp1</span><span class="o">.</span><span class="n">single_source_test</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flp1</span><span class="o">.</span><span class="n">good_freqs</span>
            <span class="n">good_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_res_sing_src</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flp1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">good_frac</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">WARNING!</span>
<span class="s2">Less than 60</span><span class="si">% o</span><span class="s2">f P1 channels turned out good.</span>
<span class="s2">This may be due to a poor choice of base channel.</span>
<span class="s2">Consider re-running the test with different</span>
<span class="s2">bswp1 and bsep1 arguments</span>
<span class="s2">&quot;&quot;&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p2_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_feedloc_p2</span><span class="p">()</span>  <span class="c1"># Initiate FeedLocator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flp2</span><span class="o">.</span><span class="n">single_source_test</span><span class="p">()</span>
            <span class="n">good_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_res_sing_src</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flp2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">good_frac</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">WARNING!</span>
<span class="s2">Less than 60</span><span class="si">% o</span><span class="s2">f P2 channels turned out good.</span>
<span class="s2">This may be due to a poor choice of base channel.</span>
<span class="s2">Consider re-running the test with different</span>
<span class="s2">bswp2 and bsep2 arguments</span>
<span class="s2">&quot;&quot;&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flp2</span><span class="o">.</span><span class="n">good_freqs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flp2</span><span class="o">.</span><span class="n">good_freqs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results_summary</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">full_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No sources available.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">single_source_check</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Nipts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">good_ipts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nipts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">postns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nipts</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expostns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nipts</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p1_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_feedloc_p1</span><span class="p">()</span>  <span class="c1"># Initiate FeedLocator</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flp1</span><span class="o">.</span><span class="n">get_dists</span><span class="p">()</span>  <span class="c1"># Run tests</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flp1</span><span class="o">.</span><span class="n">get_postns</span><span class="p">()</span>  <span class="c1"># Solve for positions</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flp1</span><span class="o">.</span><span class="n">good_freqs</span>
                <span class="n">good_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_test_res</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flp1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">good_frac</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">WARNING!</span>
<span class="s2">Less than 60</span><span class="si">% o</span><span class="s2">f P1 channels turned out good.</span>
<span class="s2">This may be due to a poor choice of base channel.</span>
<span class="s2">Consider re-running the test with different</span>
<span class="s2">bswp1 and bsep1 arguments</span>
<span class="s2">&quot;&quot;&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p2_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_feedloc_p2</span><span class="p">()</span>  <span class="c1"># Initiate FeedLocator</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flp2</span><span class="o">.</span><span class="n">get_dists</span><span class="p">()</span>  <span class="c1"># Run tests</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flp2</span><span class="o">.</span><span class="n">get_postns</span><span class="p">()</span>  <span class="c1"># Solve for positions</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flp2</span><span class="o">.</span><span class="n">good_freqs</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">good_freqs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flp2</span><span class="o">.</span><span class="n">good_freqs</span>
                    <span class="p">)</span>
                <span class="n">good_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_test_res</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flp2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">good_frac</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">WARNING!</span>
<span class="s2">Less than 60</span><span class="si">% o</span><span class="s2">f P2 channels turned out good.</span>
<span class="s2">This may be due to a poor choice of base channel.</span>
<span class="s2">Consider re-running the test with different</span>
<span class="s2">bswp2 and bsep2 arguments</span>
<span class="s2">&quot;&quot;&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">results_summary</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">results_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_ipts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_map</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deemed_bad_but_good</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_map</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pwds</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_not_accounted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_map</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pwds</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO: maybe use only x-position. Y is too erratic...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">postns</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">expostns</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wrong_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_err</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_test_res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fl</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ipt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">fl_ipt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fl_ipt</span> <span class="o">==</span> <span class="n">ipt</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                    <span class="c1"># TODO: add some treatment for c_x2 (mean? test diff?)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postns</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">c_x1</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postns</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">c_y</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">expostns</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">expx</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">expostns</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">expy</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">good_ipts</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_res_sing_src</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fl</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ipt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">fl_ipt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fl_ipt</span> <span class="o">==</span> <span class="n">ipt</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">good_ipts</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">good_ipts</span><span class="o">.</span><span class="n">size</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013–2024, CHIME Collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>